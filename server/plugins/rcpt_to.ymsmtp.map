{"version":3,"sources":["YmSmtpLog.coffee","YmSmtpRcpt.coffee","rcpt_to.ymsmtp.coffee"],"names":[],"mappings":"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","file":"rcpt_to.ymsmtp.js","sourceRoot":"","sourcesContent":["class YmSmtpLog\n\t_ = require('lodash')\n\tconstructor:(haraka)->\n\t\t@haraka=haraka\n\t\t@fs=require('fs')\n\t\t@util=require('util');\n\t\t@logfile=__dirname.replace(/\\/[^\\/]+\\/[^\\/]+$/,'')+\"/logs/ymsmtp.log\";\n\n\tlog:(data,maxDepth=10)=>\n\t\tif typeof data=='string'\n\t\t\t@out(data,1)\n\t\telse\t\n\t\t\t@out('Dump:'+@dump(data,maxDepth),1)\n\n\tout:(string,level=1)=>\n\t\t@fs.appendFile(@logfile,\"[#{level}] \"+new Date().toString()+' '+string.toString().trim()+\"\\n\",(err)=>\n\t\t\tif (err)\n\t\t\t\t@haraka.logcrit err\n  \t\t)\n\n\tdump:(o,maxDepth,path='',objects=[],depth=0)=>\n\t\tif (maxDepth==depth)\n\t\t\treturn '';\n\t\tpad = '~'\n\t\tout = ''\n\t\ttoDump = {};\n\t\tfor k,v of o\n\t\t\ttype = typeof v\n\t\t\tswitch type\n\t\t\t\twhen 'string'\n\t\t\t\t\tout+=\"\\n\"+Array(depth+1).join(pad)+(type+\": \"+path+k+'['+v+']');\n\t\t\t\twhen 'function'\n\t\t\t\t\tout+=\"\\n\"+Array(depth+1).join(pad)+(type+\": \"+path+k+'['+v.toString().split('\\n')[0].replace( /{.*/gm ,'' )+']');\n\t\t\t\twhen 'boolean'\n\t\t\t\t\tout+=\"\\n\"+Array(depth+1).join(pad)+(type+\": \"+path+k+'['+v+']');\n\t\t\t\twhen 'number'\n\t\t\t\t\tout+=\"\\n\"+Array(depth+1).join(pad)+(type+\": \"+path+k+'['+v+']');\n\t\t\t\twhen 'undefined'\n\t\t\t\t\tout+=\"\\n\"+Array(depth+1).join(pad)+(type+\": \"+path+k+'['+v+']');\n\t\t\t\twhen 'object'\n\t\t\t\t\tif (_.indexOf objects,v) ==-1\n\t\t\t\t\t\tout+=\"\\n\"+Array(depth+1).join(pad)+\"New \"+type+\": \"+path+k+'{'+_.size(v)+'}';\n\t\t\t\t\t\tobjects.push(v)\n\t\t\t\t\t\tout+=@dump(v,maxDepth,path+k+'.',objects,depth+1);\n\t\t\t\t\telse\n\t\t\t\t\t\tout+=\"\\n\"+Array(depth+1).join(pad)+\"Seen \"+type+\": \"+path+k+'{'+_.size(o[k])+'}';\n\t\t\t\telse\n\t\t\t\t\tout+=(\"\\n\"+Array(depth+1).join(pad)+\"???->\"+type+\": \"+path+k+'[NA]');\n\t\t\n\t\treturn out+\"\\n\";\n\t\t","class YmSmtpRcpt\n\tconstructor:(haraka, next, connection, params)->\n\t\t@log=new YmSmtpLog(haraka).log\n\t\t@data=\n\t\t\trcpt:params[0].toString()\n\t\t\tfrom:connection.transaction.mail_from.toString()\n\t\t\tip:connection.remote_ip\n\t\t\thost:connection.remote_host\n\t\t\tuuid:connection.uuid\n\t\t@log(\"New message [\"+@data.uuid+\"] from \"+@data.from+\" for \"+@data.rcpt+\" host: \"+@data.ip)\n\t\t# If we want to somehow limit the recipient, from, ip etc we should do that here\n\t\t# for now we just log the information and move on to the queue where the magic happens\n\t\tnext(OK)\n","# rcpt_to.ymsmtp\n# documentation via: haraka -c /home/marius/Development/ymsmtp/project/server -h plugins/rcpt_to.ymsmtp\n# Put your plugin code here\n# type: `haraka -h Plugins` for documentation on how to create a plugin\nexports.hook_rcpt = (next, connection, params) ->\n\tnew YmSmtpRcpt(this, next, connection, params)\n"]}