{"version":3,"sources":["YmSmtpLog.coffee","YmSmtpRcpt.coffee","rcpt_to.ymsmtp.coffee"],"names":[],"mappings":"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","file":"rcpt_to.ymsmtp.js","sourceRoot":"","sourcesContent":["class YmSmtpLog\n\t_ = require('lodash')\n\tconstructor:(haraka)->\n\t\t@haraka=haraka\n\t\t@fs=require('fs')\n\t\t@util=require('util');\n\t\t@logfile=__dirname.replace(/\\/[^\\/]+\\/[^\\/]+$/,'')+\"/logs/ymsmtp.log\";\n\n\tlog:(data,maxDepth=10)=>\n\t\tif typeof data=='string'\n\t\t\t@out(data,1)\n\t\telse\t\n\t\t\t@out('Dump:'+@dump(data,maxDepth),1)\n\n\tout:(string,level=1)=>\n\t\t@fs.appendFile(@logfile,\"[#{level}] \"+new Date().toString()+' '+string.toString().trim()+\"\\n\",(err)=>\n\t\t\tif (err)\n\t\t\t\t@haraka.logcrit err\n  \t\t)\n\n\tdump:(o,maxDepth,path='',objects=[],depth=0)=>\n\t\tif (maxDepth==depth)\n\t\t\treturn '';\n\t\tpad = '~'\n\t\tout = ''\n\t\ttoDump = {};\n\t\tfor k,v of o\n\t\t\ttype = typeof v\n\t\t\tswitch type\n\t\t\t\twhen 'string'\n\t\t\t\t\tout+=\"\\n\"+Array(depth+1).join(pad)+(type+\": \"+path+k+'['+v+']');\n\t\t\t\twhen 'function'\n\t\t\t\t\tout+=\"\\n\"+Array(depth+1).join(pad)+(type+\": \"+path+k+'['+v.toString().split('\\n')[0].replace( /{.*/gm ,'' )+']');\n\t\t\t\twhen 'boolean'\n\t\t\t\t\tout+=\"\\n\"+Array(depth+1).join(pad)+(type+\": \"+path+k+'['+v+']');\n\t\t\t\twhen 'number'\n\t\t\t\t\tout+=\"\\n\"+Array(depth+1).join(pad)+(type+\": \"+path+k+'['+v+']');\n\t\t\t\twhen 'undefined'\n\t\t\t\t\tout+=\"\\n\"+Array(depth+1).join(pad)+(type+\": \"+path+k+'['+v+']');\n\t\t\t\twhen 'object'\n\t\t\t\t\tif (_.indexOf objects,v) ==-1\n\t\t\t\t\t\tout+=\"\\n\"+Array(depth+1).join(pad)+\"New \"+type+\": \"+path+k+'{'+_.size(v)+'}';\n\t\t\t\t\t\tobjects.push(v)\n\t\t\t\t\t\tout+=@dump(v,maxDepth,path+k+'.',objects,depth+1);\n\t\t\t\t\telse\n\t\t\t\t\t\tout+=\"\\n\"+Array(depth+1).join(pad)+\"Seen \"+type+\": \"+path+k+'{'+_.size(o[k])+'}';\n\t\t\t\telse\n\t\t\t\t\tout+=(\"\\n\"+Array(depth+1).join(pad)+\"???->\"+type+\": \"+path+k+'[NA]');\n\t\t\n\t\treturn out+\"\\n\";\n\t\t","class YmSmtpRcpt\n\tconstructor:(haraka, next, connection, params)->\n\t\t@log=new YmSmtpLog(haraka).log\n\t\tconnection.transaction.notes.ym=\n\t\t\trcpt:params[0].toString()\n\t\t\tfrom:connection.transaction.mail_from.toString()\n\t\t\tip:connection.remote_ip\n\t\t\thost:connection.remote_host\n\t\t\tuuid:connection.uuid\n\t\t\tparts:[]\n\t\t\tattachments:[]\n\t\t\tsubject:null\n\t\t\ttasks:[]\n\t\t\ttaskErrors:[]\n\t\t\tnext:null\n\n\t\t# due to the async nature of nodeJS and the way we handle attachments, streams and the connection the final \"next\" call that is made in the queue fase should be deferred until all running\n\t\t# async tasks are ready. To do this we keep track of the tasks in an array on our ym notes. \n\n\t\t# add a task to the stack\n\t\tconnection.transaction.notes.ym.addTask= (object)=>\n\t\t\tlen = connection.transaction.notes.ym.tasks.push object\n\t\t\t@log \"Number of tasks is now: \" + len\n\t\t\treturn connection.transaction.notes.ym.tasks.indexOf object\n\n\t\t# remove the completed task from the stack, keep track of the tasks errors and if no more tasks are to be done check if we already have a final next() function to call\n\t\tconnection.transaction.notes.ym.ready= (object,error=null)=>\n\t\t\tif error?\n\t\t\t\ttaskErrors.push error\n\t\t\ti = connection.transaction.notes.ym.tasks.indexOf object\n\t\t\t@log(\"task ready:\"+i)\n\t\t\tconnection.transaction.notes.ym.tasks = connection.transaction.notes.ym.tasks.filter (o) -> o!=object\n\t\t\t@log \"Number of tasks is now: \" + connection.transaction.notes.ym.tasks.length\n\t\t\tif connection.transaction.notes.ym.tasks.length==0 and connection.transaction.notes.ym.next?\n\t\t\t\tconnection.transaction.notes.ym.next()\n\n\t\tconnection.transaction.notes.ym.setNext = (next)=>\n\t\t\t@log(\"Receiving final next() function\")\n\t\t\tconnection.transaction.notes.ym.next = next\n\t\t\tif connection.transaction.notes.ym.tasks.length==0\n\t\t\t\tconnection.transaction.notes.ym.next()\n\n\t\t@log(\"New message [\"+connection.transaction.notes.ym.uuid+\"] from \"+connection.transaction.notes.ym.from+\" for \"+connection.transaction.notes.ym.rcpt+\" host: \"+connection.transaction.notes.ym.ip)\n\t\t# If we want to somehow limit the recipient, from, ip etc we should do that here\n\t\t# for now we just log the information and move on to the queue where the magic happens\n\t\t# accept the recipient and allow the email to be delivered\n\t\tnext(OK)\n","# rcpt_to.ymsmtp\n# documentation via: haraka -c /home/marius/Development/ymsmtp/project/server -h plugins/rcpt_to.ymsmtp\n# Put your plugin code here\n# type: `haraka -h Plugins` for documentation on how to create a plugin\nexports.hook_rcpt = (next, connection, params) ->\n\tnew YmSmtpRcpt(this, next, connection, params)\n"]}