{"version":3,"sources":["start.coffee"],"names":[],"mappings":"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","file":"start.js","sourceRoot":"","sourcesContent":["# Server startup script\nclass YmSmtpStart\n\trequire('colors');\n\n\tconstructor:()->\n\t\t@debuglevel=10\n\t\t@name='Youmagine SMTP'\n\t\t# must be root\n\t\tif process.getuid()>1\n\t\t\t@err \"You must be root to start #{@name}\"\n\t\t\tprocess.exit(1);\n\t\t@debug 1,\"Starting #{@name} \"\n\t\t@checkUsers()\n\t\t@setupServer()\n\t\t@startHaraka()\t\n\n\tcheckUsers:=>\n\t\tposix = require('posix')\n\t\ttry\n\t\t\t@uid=posix.getpwnam('nobody')\n\t\t\t@gid=posix.getgrnam('nogroup')\n\t\tcatch e\n\t\t\t# do nothing \n\t\t\t@err \"I want to drop privileges to nobody/nogroup, but the unix user and group do not exist\",e\n\t\t\tprocess.exit(1);\n\n\n\tsetupServer:=>\n\t\trsync = require('rsync');\n\t\tsync = new rsync().flags('ar').source(\"#{__dirname}/project/server/\").destination(\"#{__dirname}/server/\");\n\t\tsync.execute( (error, code, cmd)=>\n\t\t\tif error?\n\t\t\t\t@err 'Failed to sync server configuration',error,code,cmd\n\t\t\t\tprocess.exit(1);\n\t\t\t@debug 1,\"Synced server configuration\"\n\t\t)\n    \n\tstartHaraka:=>\n\t\tforever = require('forever-monitor');\n\t\tconfig=\n\t\t\tmax:3 \n\t\t\targs:['--config',\"#{__dirname}/server/\"]\n\t\t\tminUptime:2000\n\t\t\tspinSleepTime:2000\n\t\t\tlogFile:\"#{__dirname}/logs/log.log\"\n\t\t\toutFile:\"#{__dirname}/logs/log.out\"\n\t\t\terrFile:\"#{__dirname}/logs/log.err\"\n\t\t\tsilent:true\n\n\t\tif @debuglevel>3\n\t\t\tconfig.silent = false\n\n\t\tchild = new (forever.Monitor)(\"#{__dirname}/node_modules/Haraka/bin/haraka\",config)\n\t\tchild.on('start', (p,d)=>\n\t\t\t@debug 3,'Haraka start'.blue,'PID:',d.pid,'FPID:',d.foreverPid\n\t\t);\n\t\tchild.on('stop', (p)=>\n\t\t\t@debug 3,'Haraka stopped'.blue\n\t\t);\n\t\tchild.on('restart', ()=>\n\t\t\t@debug 3,'Haraka restart'.blue,'PID:',child.childData.pid,'FPID:',child.childData.foreverPid\n\t\t);\n\t\tchild.on('error', (e)=>\n\t\t\t@err 'Haraka error'.blue,e,\"Check logfiles in logs/ to see what might have happened\";\n\t\t);\n\t\tchild.on('exit', (c)=>\n\t\t\t@err 'Haraka ended'.blue,\"Check logfiles in logs/ to see what might have happened\";\n\t\t);\n\t\tchild.start()\n\n\tdebug:(level,data...)=>\n\t\tif level<=@debuglevel\n\t\t\tconsole.error 'YmSmtpStart'.green,data...\n\n\terr:(data...)=>\n\t\tif @debuglevel>0\n\t\t\tconsole.error 'YmSmtpStart'.red.bgWhite,data...\n\nnew YmSmtpStart()\n\n\n"]}