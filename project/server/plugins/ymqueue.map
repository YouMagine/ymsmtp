{"version":3,"sources":["YmSmtpLog.coffee","YmQueue.coffee"],"names":[],"mappings":"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","file":"ymqueue.js","sourceRoot":"","sourcesContent":["class YmSmtpLog\n\t_ = require('lodash')\n\tconstructor:(haraka)->\n\t\t@haraka=haraka\n\t\t@fs=require('fs')\n\t\t@util=require('util');\n\t\t@logfile=__dirname.replace(/\\/[^\\/]+\\/[^\\/]+$/,'')+\"/logs/ymsmtp.log\";\n\n\tlog:(data,maxDepth=10)=>\n\t\tif typeof data=='string'\n\t\t\t@out(data,1)\n\t\telse\t\n\t\t\t@out('Dump:'+@dump(data,maxDepth),1)\n\n\tout:(string,level=1)=>\n\t\t@fs.appendFile(@logfile,\"[#{level}] \"+new Date().toString()+' '+string.toString().trim()+\"\\n\",(err)=>\n\t\t\tif (err)\n\t\t\t\t@haraka.logcrit err\n  \t\t)\n\n\tdump:(o,maxDepth,path='',objects=[],depth=0)=>\n\t\tif (maxDepth==depth)\n\t\t\treturn '';\n\t\tpad = '~'\n\t\tout = ''\n\t\ttoDump = {};\n\t\tfor k,v of o\n\t\t\ttype = typeof v\n\t\t\tswitch type\n\t\t\t\twhen 'string'\n\t\t\t\t\tout+=\"\\n\"+Array(depth+1).join(pad)+(type+\": \"+path+k+'['+v+']');\n\t\t\t\twhen 'function'\n\t\t\t\t\tout+=\"\\n\"+Array(depth+1).join(pad)+(type+\": \"+path+k+'['+v.toString().split('\\n')[0].replace( /{.*/gm ,'' )+']');\n\t\t\t\twhen 'boolean'\n\t\t\t\t\tout+=\"\\n\"+Array(depth+1).join(pad)+(type+\": \"+path+k+'['+v+']');\n\t\t\t\twhen 'number'\n\t\t\t\t\tout+=\"\\n\"+Array(depth+1).join(pad)+(type+\": \"+path+k+'['+v+']');\n\t\t\t\twhen 'undefined'\n\t\t\t\t\tout+=\"\\n\"+Array(depth+1).join(pad)+(type+\": \"+path+k+'['+v+']');\n\t\t\t\twhen 'object'\n\t\t\t\t\tif (_.indexOf objects,v) ==-1\n\t\t\t\t\t\tout+=\"\\n\"+Array(depth+1).join(pad)+\"New \"+type+\": \"+path+k+'{'+_.size(v)+'}';\n\t\t\t\t\t\tobjects.push(v)\n\t\t\t\t\t\tout+=@dump(v,maxDepth,path+k+'.',objects,depth+1);\n\t\t\t\t\telse\n\t\t\t\t\t\tout+=\"\\n\"+Array(depth+1).join(pad)+\"Seen \"+type+\": \"+path+k+'{'+_.size(o[k])+'}';\n\t\t\t\telse\n\t\t\t\t\tout+=(\"\\n\"+Array(depth+1).join(pad)+\"???->\"+type+\": \"+path+k+'[NA]');\n\t\t\n\t\treturn out+\"\\n\";\n\t\t","exports.hook_queue = (next, connection)=>\n\tnew YmQueue(next, connection)\n\nclass YmQueue\n\tconstructor:(next, connection)->\n\t\t@data=connection.transaction.notes.ym;\n\n\t\t@log=new YmSmtpLog(this).log\n\t\t@fs= require('fs')\n\t\t@next=next\n\t\temlFileName=__dirname.replace(/\\/[^\\/]+\\/[^\\/]+$/,'')+'/spool/'+connection.uuid+'.eml'\n\t\tws = @fs.createWriteStream(emlFileName)\n\t\t@data.addTask(ws)\n\t\tws.on('error',(err)=>\n\t\t\treturn @deny(\"Failed to write to spool... sorry!\")\n\t\t\t@data.ready(ws)\n\t\t)\n\t\tws.once 'close',=>\n\t\t\t@log(\"Wrote #{emlFileName}\")\n\t\t\t@data.ready(ws)\n\t\t\t\n\n\t\tconnection.transaction.message_stream.pipe(ws);\n\n\t\t# note that information we parse is put in connection.transaction.notes.ym and there is already stuff in there from the rcpt phase\n\t\t\n\t\t@data.subject = connection.transaction.body.header.get('subject')\n\n\t\t# in the data parts we store everything that we find in the email body and subparts\n\t\t# note that this uses a recursive approach for getting mimeparts from the body and flattens this structure\n\t\t\n\t\t@parseBodyChildren(connection.transaction.body)\n\n\t\t\n\n\t\t# parse the email body parts and attachments\n\t\t# @log(connection.transaction.notes,1)\n\n\t\t\n\t\t\n\t\t# if we came this far we assume it worked\n\t\t@data.setNext(=>\n\t\t\t@log(@data);\n\t\t\t@ok;\n\t\t)\n\t\t\n\tparseBodyChildren:(body)=>\n\t\to = {}\n\t\to.text = body.bodytext.trim()\n\t\to.size = o.text.length\n\t\to.type = body.header.get('content-type').toLowerCase().replace('\\n',' ').replace(/\\s+/,' ').trim()\n\t\t# we do not need to keep certain types\n\t\tif o?.type.match 'multipart/alternative'\n\t\t\to = null\n\t\tif o?.type.match 'multipart/mixed'\n\t\t\to = null\n\t\t# other types to ignore?\n\t\tif o?\n\t\t\t@data.parts.push o\n\t\tfor c in body.children\n\t\t\t@parseBodyChildren(c)\n\t\treturn true\n\n\tdeny:(message)=>\n\t\tif !message?\n\t\t\tmessage = \"Sorry but that failed\"\n\t\t@log message\n\t\treturn @next(DENY,message);\n\n\tok:(message)=>\n\t\tif !message?\n\t\t\tmessage = \"That turned out quite well\"\n\t\t@log message\n\t\treturn @next(OK);"]}